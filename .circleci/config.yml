version: 2.1
jobs:
  # Lint the application to check any build/syntax errors
  build-application:
    docker:
      - image: python:3.7.3-stretch
    working_directory: ~/repo
    steps:
      - checkout
      - run:
          name: Install dependencies and hadolint
          command: |
            cd azure-vote
            make install

      - run:
          name: Lint the application
          command: |
            cd azure-vote
            make lint           

  # Deploy the application to the AWS K8s cluster
  deploy-application:
    docker:
      # aws-cli/2.3.4 Python/3.8.8 Linux/4.15.0-1110-aws docker/x86_64
      - image: amazon/aws-cli
    steps:
      - checkout
      - run:
          name: Check AWS version
          command: |
            aws --version
            kubectl version --client
            ls -l

workflows:
  default:
    jobs:
      - build-application
      - deploy-application
  